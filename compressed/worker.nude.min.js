var skinRegions=[],skinMap=[],canvas={};onmessage=function(event){canvas.width=event.data[1];canvas.height=event.data[2];scanImage(event.data[0])};Array.prototype.remove=function(index){var rest=this.slice(index+1);this.length=index;return this.push.apply(this,rest)};function scanImage(imageData){var detectedRegions=[],mergeRegions=[],width=canvas.width,lastFrom=-1,lastTo=-1;var addMerge=function(from,to){lastFrom=from;lastTo=to;var len=mergeRegions.length,fromIndex=-1,toIndex=-1;while(len--){var region=mergeRegions[len],rlen=region.length;while(rlen--){if(region[rlen]==from){fromIndex=len}if(region[rlen]==to){toIndex=len}}}if(fromIndex!=-1&&toIndex!=-1&&fromIndex==toIndex){return}if(fromIndex==-1&&toIndex==-1){mergeRegions.push([from,to]);return}if(fromIndex!=-1&&toIndex==-1){mergeRegions[fromIndex].push(to);return}if(fromIndex==-1&&toIndex!=-1){mergeRegions[toIndex].push(from);return}if(fromIndex!=-1&&toIndex!=-1&&fromIndex!=toIndex){mergeRegions[fromIndex]=mergeRegions[fromIndex].concat(mergeRegions[toIndex]);mergeRegions.remove(toIndex);return}};var length=imageData.length,width=canvas.width;for(var i=0,u=1;i<length;i+=4,u++){var r=imageData[i],g=imageData[i+1],b=imageData[i+2],x=(u>width)?((u%width)-1):u,y=(u>width)?(Math.ceil(u/width)-1):1;if(classifySkin(r,g,b)){skinMap.push({id:u,skin:true,region:0,x:x,y:y,checked:false});var region=-1,checkIndexes=[u-2,(u-width)-2,u-width-1,(u-width)],checker=false;for(var o=0;o<4;o++){var index=checkIndexes[o];if(skinMap[index]&&skinMap[index].skin){if(skinMap[index].region!=region&&region!=-1&&lastFrom!=region&&lastTo!=skinMap[index].region){addMerge(region,skinMap[index].region)}region=skinMap[index].region;checker=true}}if(!checker){skinMap[u-1].region=detectedRegions.length;detectedRegions.push([skinMap[u-1]]);continue}else{if(region>-1){if(!detectedRegions[region]){detectedRegions[region]=[]}skinMap[u-1].region=region;detectedRegions[region].push(skinMap[u-1])}}}else{skinMap.push({id:u,skin:false,region:0,x:x,y:y,checked:false})}}merge(detectedRegions,mergeRegions);analyseRegions()}function merge(detectedRegions,mergeRegions){var length=mergeRegions.length,detRegions=[];while(length--){var region=mergeRegions[length],rlen=region.length;if(!detRegions[length]){detRegions[length]=[]}while(rlen--){var index=region[rlen];detRegions[length]=detRegions[length].concat(detectedRegions[index]);detectedRegions[index]=[]}}var l=detectedRegions.length;while(l--){if(detectedRegions[l].length>0){detRegions.push(detectedRegions[l])}}clearRegions(detRegions)}function clearRegions(detectedRegions){var length=detectedRegions.length;for(var i=0;i<length;i++){if(detectedRegions[i].length>30){skinRegions.push(detectedRegions[i])}}}function analyseRegions(){var length=skinRegions.length,totalPixels=canvas.width*canvas.height,totalSkin=0;if(length<3){postMessage(false);return}(function(){var sorted=false;while(!sorted){sorted=true;for(var i=0;i<length-1;i++){if(skinRegions[i].length<skinRegions[i+1].length){sorted=false;var temp=skinRegions[i];skinRegions[i]=skinRegions[i+1];skinRegions[i+1]=temp}}}})();while(length--){totalSkin+=skinRegions[length].length}if((totalSkin/totalPixels)*100<15){postMessage(false);return}if((skinRegions[0].length/totalSkin)*100<35&&(skinRegions[1].length/totalSkin)*100<30&&(skinRegions[2].length/totalSkin)*100<30){postMessage(false);return}if((skinRegions[0].length/totalSkin)*100<45){postMessage(false);return}if(skinRegions.length>60){postMessage(false);return}postMessage(true)}function classifySkin(r,g,b){var rgbClassifier=((r>95)&&(g>40&&g<100)&&(b>20)&&((Math.max(r,g,b)-Math.min(r,g,b))>15)&&(Math.abs(r-g)>15)&&(r>g)&&(r>b)),nurgb=toNormalizedRgb(r,g,b),nr=nurgb[0],ng=nurgb[1],nb=nurgb[2],normRgbClassifier=(((nr/ng)>1.185)&&(((r*b)/(Math.pow(r+g+b,2)))>0.107)&&(((r*g)/(Math.pow(r+g+b,2)))>0.112));var hsv=toHsv(r,g,b),h=hsv[0],s=hsv[1],hsvClassifier=(h>0&&h<35&&s>0.23&&s<0.68);var ycc=toYcc(r,g,b),y=ycc[0],cb=ycc[1],cr=ycc[2],yccClassifier=((y>80)&&(cb>77&&cb<127)&&(cr>133&&cr<173));return(rgbClassifier||normRgbClassifier||hsvClassifier||yccClassifier)}function toYcc(r,g,b){var y=16+0.299*r+0.587*g+0.114*b,cr=128-0.16874*r-0.33126*g+0.5*b,cb=128+0.5*r-0.41869*g-0.08131*b;return[y,cr,cb]}function toHsv(r,g,b){var h=0,max=Math.max(r,g,b),min=Math.min(r,g,b),diff=max-min;if(max==r){h=(g-b)/diff}else{if(max==g){h=2+((g-r)/diff)}else{h=4+((r-g)/diff)}}h=h*60;if(h<0){h=h+360}return[h,1-(3*(max/(r+g+b))),(1/3)*(r+g+b)]}function toNormalizedRgb(r,g,b){var sum=r+g+b;return[(r/sum),(g/sum),(b/sum)]};